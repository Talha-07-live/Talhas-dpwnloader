<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Talha's Downloader</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .animate-fade { animation: fadeInUp 0.6s ease-in-out both; }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
    }
    body { background: linear-gradient(to right, #0f0f0f, #1a1a1a); }
  </style>
</head>
<body class="text-white min-h-screen flex items-center justify-center px-4">

  <div class="w-full max-w-md p-6 rounded-xl glass animate-fade shadow-xl">
    <h1 class="text-3xl font-extrabold text-center mb-6">üîó Talha's Downloader</h1>

    <form id="downloadForm" class="space-y-4">
      <input
        type="url"
        id="url"
        placeholder="Enter Direct Download URL"
        class="w-full p-3 rounded bg-black/30 text-dark border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        required
      />
      <input
        type="text"
        id="name"
        placeholder="Enter File Name (e.g. myvideo.mp4)"
        class="w-full p-3 rounded bg-black/30 text-dark border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        required
      />
      <button
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-800 transition-colors p-3 rounded text-white font-semibold"
      >
        ‚ö° Generate Download Link
      </button>
    </form>

    <div id="result" class="hidden mt-8 text-center animate-fade">
      <h2 class="text-xl font-bold mb-4">‚úÖ Download Link Generated</h2>
      <a
        id="downloadBtn"
        href="#"
        class="inline-block bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold transition-colors"
        >‚¨áÔ∏è Download Here</a
      >
      <p class="text-xs text-gray-300 mt-4 bg-gray-800 p-3 rounded leading-relaxed">
        <strong>Welcome to Talha's Downloader.</strong><br />
        This page made for <span class="text-white font-semibold">"Talha's Collection"</span>.<br />
        <span class="font-semibold text-white">Made by Talha</span>
      </p>
    </div>
  </div>

  <script>
    const SECRET_KEY = "Talha<what!"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ worker ‡¶è‡¶∞ secret key ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶è‡¶ï‡¶á ‡¶π‡¶¨‡ßá

    // TextEncoder helper
    const encoder = new TextEncoder();

    // HMAC SHA-256 ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ (Web Crypto API)
    async function generateSignature(url, timestamp) {
      const keyData = encoder.encode(SECRET_KEY);
      const cryptoKey = await crypto.subtle.importKey(
        "raw",
        keyData,
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
      );
      const data = encoder.encode(url + timestamp);
      const signatureBuffer = await crypto.subtle.sign("HMAC", cryptoKey, data);
      const signatureArray = Array.from(new Uint8Array(signatureBuffer));
      const signatureHex = signatureArray
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
      return signatureHex;
    }

    // AES-GCM Encrypt function (Worker ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã same)
    async function encrypt(text) {
      const data = encoder.encode(text);
      const keyData = encoder.encode(SECRET_KEY.padEnd(32, " "));
      const cryptoKey = await crypto.subtle.importKey(
        "raw",
        keyData.slice(0, 32),
        "AES-GCM",
        false,
        ["encrypt"]
      );
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encryptedBuffer = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, data);
      const fullBuffer = new Uint8Array(iv.length + encryptedBuffer.byteLength);
      fullBuffer.set(iv);
      fullBuffer.set(new Uint8Array(encryptedBuffer), iv.length);
      // base64 encode
      return btoa(String.fromCharCode(...fullBuffer));
    }

    // sanitize filename function (same as worker)
    function sanitize(name) {
      return name.trim().replace(/[<>:"/\\|?*]+/g, "_");
    }

    document.getElementById("downloadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const urlRaw = document.getElementById("url").value.trim();
      const nameRaw = document.getElementById("name").value.trim();

      if (!urlRaw || !nameRaw) {
        alert("URL ‡¶è‡¶¨‡¶Ç ‡¶®‡¶æ‡¶Æ ‡¶â‡¶≠‡ßü‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
      }

      const timestamp = Date.now().toString();
      const sanitizedFileName = sanitize(nameRaw);
      const signature = await generateSignature(urlRaw, timestamp);

      // Prepare payload object
      const payload = {
        url: urlRaw,
        ts: timestamp,
        sig: signature,
        name: sanitizedFileName,
      };

      // Encrypt payload JSON string
      const encryptedPayload = await encrypt(JSON.stringify(payload));

      // Prepare final link with ?data=encryptedPayload
      const worker = "https://talhasdownloader.talha07.workers.dev";
      const finalLink = `${worker}/?data=${encodeURIComponent(encryptedPayload)}`;

      // Show result
      const downloadBtn = document.getElementById("downloadBtn");
      downloadBtn.href = finalLink;
      document.getElementById("result").classList.remove("hidden");
    });
  </script>
</body>
</html>
